<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const startInput = document.getElementById("startDate");
    const endInput = document.getElementById("endDate");
    const priceSummary = document.getElementById("price-summary");
    const totalPriceElem = document.getElementById("total-price");
    const pricePerNight = parseFloat(document.getElementById("price-per-night").innerText);
    const form = document.querySelector("form");
    const guestInput = document.querySelector('input[name="guest_number"]');

    // âœ… Philippine Time Display
    const timeDisplay = document.createElement("div");
    timeDisplay.style = "margin-bottom: 15px; font-weight: 600; color: #1e293b;";
    timeDisplay.id = "ph-time-display";
    document.body.prepend(timeDisplay);

    function updatePHTime() {
        const nowPH = new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" });
        timeDisplay.innerHTML = "ðŸ‡µðŸ‡­ Current Philippine Time: " + nowPH;
    }
    updatePHTime();
    setInterval(updatePHTime, 1000);

    // âœ… Force timezone to Asia/Manila
    const nowInPH = new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" });
    const today = new Date(nowInPH).toISOString().split("T")[0];

    // Set minimum selectable dates
    if (startInput) startInput.min = today;
    if (endInput) endInput.min = today;

    // ðŸ§® Price Calculation
    function calculatePrice() {
        if (startInput.value && endInput.value) {
            const start = new Date(startInput.value);
            const end = new Date(endInput.value);

            if (end > start) {
                const nights = Math.floor((end - start) / (1000 * 60 * 60 * 24));
                let total = nights * pricePerNight;

                const guests = parseInt(guestInput.value) || 0;
                if (guests > 6) {
                    const extraGuests = guests - 6;
                    const extraFee = extraGuests * 500;
                    total += extraFee;
                    totalPriceElem.textContent =
                        `Total for ${nights} night${nights > 1 ? 's' : ''} (â‚±${extraFee.toLocaleString()} extra for ${extraGuests} guest${extraGuests > 1 ? 's' : ''}): â‚±${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                } else {
                    totalPriceElem.textContent =
                        `Total for ${nights} night${nights > 1 ? 's' : ''}: â‚±${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}`;
                }

                priceSummary.style.display = "block";
            } else {
                priceSummary.style.display = "none";
            }
        } else {
            priceSummary.style.display = "none";
        }
    }

    // Date change listeners
    startInput.addEventListener("change", function () {
        const arrival = new Date(this.value);
        const minDeparture = new Date(arrival);
        minDeparture.setDate(arrival.getDate() + 1);
        endInput.min = minDeparture.toISOString().split("T")[0];

        if (endInput.value && new Date(endInput.value) < minDeparture) {
            endInput.value = endInput.min;
        }
        calculatePrice();
    });

    endInput.addEventListener("change", calculatePrice);
    guestInput.addEventListener("input", calculatePrice);

    // Validate before submit
    if (form) {
        form.addEventListener("submit", function (e) {
            const start = new Date(startInput.value);
            const end = new Date(endInput.value);
            const today = new Date();
            const endLimit = new Date("2026-12-31");
            today.setHours(0, 0, 0, 0);

            if (end <= start) {
                e.preventDefault();
                alert("Departure date must be at least one day after arrival date.");
                return;
            }

            if (start < today || end > endLimit) {
                e.preventDefault();
                alert("Bookings are only allowed from today up to December 31, 2026.");
                return;
            }
        });
    }

    // ðŸ—“ï¸ FullCalendar with PH timezone
    const staycationId = "{{ $staycation->id }}";
    if (document.getElementById("calendar")) {
        fetch(`/events/${staycationId}`)
            .then(res => res.json())
            .then(events => {
                // Filter out past bookings ðŸ”¥
                const todayPH = new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" });
                const todayDate = new Date(todayPH);
                todayDate.setHours(0, 0, 0, 0);

                const bookedEvents = events
                    .map(event => {
                        const startPH = new Date(new Date(event.start).toLocaleString("en-US", { timeZone: "Asia/Manila" }));
                        const endPH = new Date(new Date(event.end).toLocaleString("en-US", { timeZone: "Asia/Manila" }));
                        endPH.setDate(endPH.getDate() - 1);

                        return {
                            title: "Booked",
                            start: startPH.toISOString().split("T")[0],
                            end: endPH.toISOString().split("T")[0],
                            allDay: true,
                            display: "background",
                            backgroundColor: "#f56565",
                            borderColor: "#f56565",
                        };
                    })
                    .filter(event => new Date(event.end) >= todayDate); // â›” hide past bookings

                const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
                    initialView: "dayGridMonth",
                    height: "auto",
                    aspectRatio: 1.4,
                    headerToolbar: {
                        left: "prev,next today",
                        center: "title",
                        right: ""
                    },
                    timeZone: "Asia/Manila",
                    events: bookedEvents,

                    // âœ… Restrict navigation (no past months)
                    validRange: {
                        start: todayDate.toISOString().split("T")[0],
                        end: "2026-12-31" // Optional: limit max future booking range
                    },

                    // ðŸ©¶ Grey out past dates
                    dayCellDidMount: function (info) {
                        const cellDate = new Date(info.date);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        cellDate.setHours(0, 0, 0, 0);

                        if (cellDate < today) {
                            info.el.style.backgroundColor = "#e9ecef";
                            info.el.style.opacity = "0.7";
                        }
                    },

                    // ðŸš« Disable clicks on past dates
                    dateClick: function (info) {
                        const clickedDate = new Date(info.date);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        clickedDate.setHours(0, 0, 0, 0);

                        if (clickedDate < today) {
                            return; // Ignore past date clicks
                        }

                        console.log("Future date clicked:", clickedDate);
                    }
                });

                calendar.render();
            });
    }

    // ðŸ§­ Debugging logs
    console.log("Local device time:", new Date());
    console.log("Philippine time:", new Date().toLocaleString("en-US", { timeZone: "Asia/Manila" }));
});
</script>
